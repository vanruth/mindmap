<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mindmap â€” Claude-style UI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #F7F7FA;
    --panel: #FFFFFF;
    --text: #222;
    --text-dim: #666;
    --border: #E6E6EC;
    --accent: #6B5BCE; /* soft purple */
    --accent-2: #12A594; /* teal for secondary */
    --shadow-sm: 0 2px 8px rgba(16, 24, 40, 0.06);
    --shadow-md: 0 6px 18px rgba(16, 24, 40, 0.10);
    --radius-md: 14px;
    --radius-lg: 18px;
    --radius-xl: 22px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
    color:var(--text);
    background:
      radial-gradient(800px 800px at 20% -50%, #FBFAFF 0%, #F7F7FA 45%, #F4F5F9 100%),
      linear-gradient(180deg, #F9FAFB 0%, #F7F7FA 100%);
    overflow:hidden;
  }

  /* App shell layout (Claude-ish) */
  .app{
    display:grid;
    grid-template-columns: 300px 1fr;
    grid-template-rows: 64px 1fr;
    grid-template-areas:
      "sidebar header"
      "sidebar canvas";
    height:100vh;
    gap:0;
  }

  /* Header */
  .header{
    grid-area:header;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 16px;
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.75);
    backdrop-filter:saturate(1.3) blur(6px);
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .logo{
    width:36px;height:36px;border-radius:10px;
    background:linear-gradient(135deg, var(--accent), #8B7AE8);
    box-shadow:var(--shadow-sm);
  }
  .title-input{
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    padding:8px 12px;
    width:280px;
    font-size:14px;
    color:var(--text);
    outline:none;
  }

  .actions{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .btn{
    border:none;
    background:#fff;
    color:var(--text);
    border:1px solid var(--border);
    padding:8px 12px;
    border-radius:10px;
    box-shadow:var(--shadow-sm);
    cursor:pointer;
    font-size:14px;
    transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow-md); }
  .btn:disabled{ opacity:0.5; cursor:not-allowed; }
  .btn-primary{
    background:var(--accent);
    color:#fff; border-color:transparent;
  }
  .btn-secondary{
    background:#fff; color:var(--accent-2);
    border-color:var(--accent-2);
  }

  /* Sidebar (conversation list feel) */
  .sidebar{
    grid-area:sidebar;
    border-right:1px solid var(--border);
    background:rgba(255,255,255,0.9);
    backdrop-filter:saturate(1.2) blur(4px);
    display:flex;
    flex-direction:column;
    height:100%;
  }
  .sidebar-header{
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
  }
  .sidebar-title{
    font-size:14px; font-weight:600; color:#333;
  }
  .sidebar-content{
    overflow:auto; padding:8px;
  }
  .gi{
    padding:10px 12px;
    margin:6px 0;
    background:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    transition:background .12s ease, box-shadow .12s ease;
  }
  .gi:hover{ background:#F9F9FB; box-shadow:var(--shadow-sm); }
  .gt{ font-size:14px; font-weight:600; color:#222; }
  .gd{ font-size:12px; color:var(--text-dim); margin-top:2px; }
  .gi-main{ flex:1; display:flex; flex-direction:column; }
  .gi-actions{ display:flex; align-items:center; gap:4px; }
  .icon-btn{
    border:none; background:#fff; color:#555;
    border:1px solid var(--border);
    width:30px; height:30px; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:var(--shadow-sm);
  }
  .icon-btn.danger{ color:#E74C3C; }

  /* Canvas area */
  .canvas{
    grid-area:canvas;
    position:relative;
    background:
      radial-gradient(600px 600px at 80% 150%, #FFFFFF 0%, #F7F7FA 50%, #F1F2F6 100%);
    overflow:hidden;
  }

  /* Canvas drag styling */
  .canvas.grabbing{ cursor:grabbing; }
  .canvas{ cursor:grab; }

  /* SVG connections */
  svg#s{
    position:absolute; inset:0;
    width:100%; height:100%;
    pointer-events:none; z-index:0;
  }
  .conn{ stroke:#D7D9E2; stroke-width:2; fill:none; }

  /* Node bubbles (Claude-ish) */
  .node{
    position:absolute;
    background:#fff;
    border:1px solid var(--border);
    border-radius:18px 18px 18px 22px; /* subtle bubble tail feel */
    padding:14px 18px;
    min-width:120px;
    max-width:640px;
    box-shadow:var(--shadow-sm);
    transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
    z-index:10;
  }
  .node:hover{
    transform:translateY(-2px);
    box-shadow:var(--shadow-md);
    z-index:20;
  }
  .node.drag{
    opacity:.85; z-index:1000;
    transform:scale(0.995);
  }

  .bdy{
    cursor:move;
    padding:6px 2px; margin:-6px 0;
    position:relative; min-height:40px;
  }

  .txt{
    outline:none; border:none; background:transparent;
    font-size:15px; font-weight:500; color:#222;
    width:100%; text-align:left; cursor:text;
    white-space:nowrap;
  }

  /* Resize handle */
  .rh{
    position:absolute; bottom:-8px; right:-8px;
    width:16px; height:16px; border-radius:6px;
    background:#fff; border:1px solid var(--border);
    box-shadow:var(--shadow-sm);
    cursor:nwse-resize; z-index:40;
    opacity:0; transition:opacity .12s ease;
  }
  .node:hover .rh{ opacity:1; }

  /* Inline actions inside node (on hover) */
  .acts{
    position:absolute; top:-12px; right:-8px;
    display:flex; gap:6px; z-index:50; opacity:0;
    transform:translateY(-4px);
    transition:opacity .12s ease, transform .12s ease;
  }
  .node:hover .acts{
    opacity:1; transform:translateY(0);
  }
  .add,.del{
    width:30px; height:30px; border-radius:10px; border:1px solid var(--border);
    background:#fff; color:#555; font-size:18px; line-height:0;
    box-shadow:var(--shadow-sm); cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
  .del{ color:#E74C3C; }

  /* Modals */
  .m-o{
    position:fixed; inset:0;
    background:rgba(16,24,40,0.35);
    z-index:10000; display:none;
    align-items:center; justify-content:center;
  }
  .m-b{
    background:#fff; padding:18px;
    border-radius:14px; box-shadow:var(--shadow-md);
    width:92%; max-width:380px; text-align:center;
  }
  .m-b h4{ margin-bottom:12px; font-size:16px; color:#333; }
  #u-o #u-d{
    width:100%; padding:10px; margin:10px 0;
    border:1px solid var(--border); background:#FAFAFC;
    font-size:14px; word-break:break-all; text-align:left; border-radius:10px;
  }
  #p-o #p-i{
    width:100%; padding:10px; margin-top:10px;
    border:1px solid var(--border); border-radius:10px; font-size:15px;
  }
  .m-b-g{ display:flex; align-items:center; justify-content:center; gap:8px; margin-top:8px; }
  .b-p{ background:var(--accent); color:white; }
  .b-s{ background:#f44336; color:white; }
  .b-i{ background:var(--accent-2); color:white; }
  .m-b-g button{
    padding:8px 14px; border:none; border-radius:10px; cursor:pointer; font-size:14px;
    box-shadow:var(--shadow-sm);
  }

  /* Subtle helper tip */
  .tip{
    position:absolute; left:20px; bottom:20px;
    background:#fff; border:1px solid var(--border);
    border-radius:12px; padding:8px 12px; font-size:13px; color:var(--text-dim);
    box-shadow:var(--shadow-sm);
  }

  /* Hide old floating gallery (we use sidebar) */
  #gal{ display:none !important; }
</style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Maps</div>
        <div>
          <button id="newMap" class="btn btn-secondary" title="New">New</button>
        </div>
      </div>
      <div id="gl" class="sidebar-content"></div>
    </aside>

    <!-- Header -->
    <header class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <input id="t" class="title-input" type="text" placeholder="Untitled map" />
      </div>
      <div class="actions">
        <button id="u" class="btn" title="Undo">â†¶ Undo</button>
        <button id="r" class="btn" title="Redo">â†· Redo</button>
        <button id="sv" class="btn btn-primary" title="Save">ðŸ’¾ Save</button>
        <button id="sa" class="btn" title="Save As">Save as</button>
        <button id="embed" class="btn" title="Embed">ðŸ”— Embed</button>
      </div>
    </header>

    <!-- Canvas -->
    <main id="c" class="canvas">
      <svg id="s"></svg>
      <div class="tip">Double-click anywhere to add a node. Drag canvas to pan. Drag the corner to resize.</div>
    </main>
  </div>

  <!-- Modals -->
  <div id="u-o" class="m-o">
    <div class="m-b">
      <h4>Copy this URL to embed this specific map in Notion:</h4>
      <div id="u-d"></div>
      <div class="m-b-g">
        <button onclick="document.getElementById('u-o').style.display='none'" class="b-s">Close</button>
      </div>
    </div>
  </div>

  <div id="p-o" class="m-o">
    <div class="m-b">
      <h4 id="pm"></h4>
      <input type="text" id="p-i" placeholder="Enter title" style="display:none;">
      <div class="m-b-g">
        <button id="pc" class="b-p" style="display:none;">Confirm</button>
        <button id="pnc" class="b-s" style="display:none;">Cancel</button>
        <button id="pao" class="b-i" style="display:none;">OK</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // Persistent key and base URL
  const STORAGE_KEY = 'mgd';
  const EMBED_BASE = 'https://apption.co/embeds/263c4704';

  // DOM
  const c = document.getElementById('c');
  const s = document.getElementById('s');
  const gl = document.getElementById('gl');

  const uO = document.getElementById('u-o');
  const uD = document.getElementById('u-d');

  const pO = document.getElementById('p-o');
  const pM = document.getElementById('pm');
  const pI = document.getElementById('p-i');
  const pC = document.getElementById('pc');
  const pNC = document.getElementById('pnc');
  const pAO = document.getElementById('pao');

  const titleInput = document.getElementById('t');
  const btnUndo = document.getElementById('u');
  const btnRedo = document.getElementById('r');
  const btnSave = document.getElementById('sv');
  const btnSaveAs = document.getElementById('sa');
  const btnNew = document.getElementById('newMap');
  const btnEmbed = document.getElementById('embed');

  // State
  let nodes = [];          // {id, el, p}
  let draggingNode = null; // element
  let dragOffsetX = 0;
  let dragOffsetY = 0;

  let panning = false;
  let panX = 0;
  let panY = 0;
  let panSnapshot = null;

  let historyStack = [];
  let historyIndex = -1;

  let currentIndex = null;
  let originalTitle = '';

  let resizingNode = null;
  let resizeStart = null;

  // Modal helpers
  function modalAlert(message){
    return new Promise(resolve=>{
      pM.textContent = message;
      pI.style.display='none';
      pC.style.display='none';
      pNC.style.display='none';
      pAO.style.display='inline-block';
      const handler=()=>{
        pAO.removeEventListener('click', handler);
        pO.style.display='none';
        resolve();
      };
      pAO.addEventListener('click', handler);
      pO.style.display='flex';
    });
  }

  function modalPrompt(message, defaultValue=''){
    return new Promise(resolve=>{
      pM.textContent = message;
      pI.value = defaultValue;
      pI.style.display='block';
      pC.style.display='inline-block';
      pNC.style.display='inline-block';
      pAO.style.display='none';
      const onConfirm=()=>{
        cleanup();
        pO.style.display='none';
        resolve(pI.value);
      };
      const onCancel=()=>{
        cleanup();
        pO.style.display='none';
        resolve(null);
      };
      function cleanup(){
        pC.removeEventListener('click', onConfirm);
        pNC.removeEventListener('click', onCancel);
      }
      pC.addEventListener('click', onConfirm);
      pNC.addEventListener('click', onCancel);
      pO.style.display='flex';
      pI.focus(); pI.select();
    });
  }

  // History
  function capture(){
    const snapshot = {
      nodes: nodes.map(n=>({
        id: n.id,
        p: n.p,
        t: n.el.querySelector('.txt').textContent,
        l: parseFloat(n.el.style.left),
        tp: parseFloat(n.el.style.top),
        w: n.el.offsetWidth,
        h: n.el.offsetHeight
      })),
      title: titleInput.value
    };
    if(historyIndex < historyStack.length-1){
      historyStack = historyStack.slice(0, historyIndex+1);
    }
    historyStack.push(JSON.parse(JSON.stringify(snapshot)));
    if(historyStack.length > 50) historyStack.shift();
    else historyIndex++;
    btnUndo.disabled = historyIndex <= 0;
    btnRedo.disabled = historyIndex >= historyStack.length-1;
  }

  function restore(state){
    clearCanvas();
    state.nodes.forEach(n => makeNode(n.t, n.l, n.tp, n.p, n.id, n.w, n.h, true));
    titleInput.value = state.title;
    btnUndo.disabled = historyIndex <= 0;
    btnRedo.disabled = historyIndex >= historyStack.length-1;
  }

  // Drawing connections
  function draw(){
    s.innerHTML='';
    nodes.forEach(n=>{
      if(!n.p) return;
      const p = nodes.find(x=>x.id===n.p);
      if(!p) return;
      const pr=p.el.getBoundingClientRect(), nr=n.el.getBoundingClientRect();
      const x1=pr.left+pr.width/2, y1=pr.top+pr.height/2;
      const x2=nr.left+nr.width/2, y2=nr.top+nr.height/2;
      const mx=(x1+x2)/2, my=(y1+y2)/2;
      const pt=document.createElementNS('http://www.w3.org/2000/svg','path');
      pt.setAttribute('d',`M${x1},${y1} Q${mx},${y1} ${mx},${my} T${x2},${y2}`);
      pt.setAttribute('class','conn');
      s.appendChild(pt);
    });
  }

  // Nodes
  function makeNode(text, x, y, parent=null, id=null, w=null, h=null, skipCapture=false){
    const d=document.createElement('div');
    d.className='node';
    d.style.left=x+'px';
    d.style.top=y+'px';
    if(w) d.style.width=w+'px';
    if(h) d.style.height=h+'px';
    id = id || ('n'+Date.now()+Math.random().toString(36).slice(2,7));
    d.dataset.id=id;
    d.dataset.p=parent || '';

    const body=document.createElement('div');
    body.className='bdy';

    const acts=document.createElement('div');
    acts.className='acts';

    const btnAdd=document.createElement('button');
    btnAdd.className='add';
    btnAdd.textContent='+';
    btnAdd.title='Add child';
    btnAdd.onclick=(e)=>{ e.stopPropagation(); addChild(id); };
    acts.appendChild(btnAdd);

    const btnDel=document.createElement('button');
    btnDel.className='del';
    btnDel.textContent='Ã—';
    btnDel.title='Delete';
    btnDel.onclick=(e)=>{ e.stopPropagation(); deleteNode(id); };
    acts.appendChild(btnDel);

    body.appendChild(acts);

    const td=document.createElement('div');
    td.className='txt';
    td.contentEditable=true;
    td.textContent=text;
    if(w && h){ td.style.whiteSpace='normal'; td.dataset.mr='true'; }
    let tm;
    td.addEventListener('input', ()=>{
      if(td.dataset.mr==='true') return;
      const mn=120, mx=640, tw=td.scrollWidth+30;
      d.style.width=Math.max(mn, Math.min(mx, tw))+'px';
      draw();
      clearTimeout(tm);
      tm=setTimeout(()=>capture(), 500);
    });
    body.appendChild(td);
    d.appendChild(body);

    const resize=document.createElement('div');
    resize.className='rh';
    resize.title='Resize';
    resize.addEventListener('mousedown', e=>{
      e.stopPropagation();
      startResize(e, d);
    });
    d.appendChild(resize);

    c.appendChild(d);
    nodes.push({id, el:d, p:parent});

    body.addEventListener('mousedown', e=>{
      if(e.target===body || e.target===td.parentElement){
        startDrag(e, d);
      }
    });

    draw();
    if(!skipCapture) capture();
    return id;
  }

  function startDrag(e, el){
    draggingNode = el;
    el.classList.add('drag');
    const rc = el.getBoundingClientRect();
    dragOffsetX = e.clientX - rc.left;
    dragOffsetY = e.clientY - rc.top;
    e.preventDefault();
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
  }
  function onDrag(e){
    if(!draggingNode) return;
    draggingNode.style.left = (e.clientX - dragOffsetX) + 'px';
    draggingNode.style.top  = (e.clientY - dragOffsetY) + 'px';
    draw();
  }
  function stopDrag(){
    if(draggingNode){
      draggingNode.classList.remove('drag');
      capture();
    }
    draggingNode = null;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
  }

  function startResize(e, el){
    resizingNode = el;
    const td = el.querySelector('.txt');
    td.style.whiteSpace='normal';
    td.dataset.mr='true';
    resizeStart = { x:e.clientX, y:e.clientY, w:el.offsetWidth, h:el.offsetHeight };
    e.preventDefault();
    document.addEventListener('mousemove', onResize);
    document.addEventListener('mouseup', stopResize);
  }
  function onResize(e){
    if(!resizingNode) return;
    const dx = e.clientX - resizeStart.x;
    const dy = e.clientY - resizeStart.y;
    resizingNode.style.width  = Math.max(120, resizeStart.w+dx) + 'px';
    resizingNode.style.height = Math.max(40,  resizeStart.h+dy) + 'px';
    draw();
  }
  function stopResize(){
    if(resizingNode) capture();
    resizingNode = null;
    document.removeEventListener('mousemove', onResize);
    document.removeEventListener('mouseup', stopResize);
  }

  function addChild(pid){
    const p = nodes.find(n=>n.id===pid);
    if(!p) return;
    const rc = p.el.getBoundingClientRect();
    const ct = nodes.filter(n=>n.p===pid).length;
    const angle = (Math.PI*2*ct/5) + (Math.random()*0.4-0.2);
    const dist = 180;
    const x = rc.left + rc.width/2 + Math.cos(angle)*dist - 70;
    const y = rc.top  + rc.height/2 + Math.sin(angle)*dist - 30;
    makeNode('New idea', x, y, pid);
  }

  function deleteNode(id){
    const i = nodes.findIndex(n=>n.id===id);
    if(i===-1) return;
    nodes.filter(n=>n.p===id).forEach(kd => deleteNode(kd.id));
    nodes[i].el.remove();
    nodes.splice(i,1);
    draw();
    capture();
  }

  // Canvas panning
  c.addEventListener('mousedown', e=>{
    if(e.target === c || e.target === s){
      panning = true;
      panX = e.clientX;
      panY = e.clientY;
      c.classList.add('grabbing');
      panSnapshot = nodes.map(n=>({
        id:n.id,
        l:parseFloat(n.el.style.left),
        tp:parseFloat(n.el.style.top)
      }));
    }
  });
  document.addEventListener('mousemove', e=>{
    if(!panning) return;
    const dx = e.clientX - panX;
    const dy = e.clientY - panY;
    nodes.forEach(n=>{
      n.el.style.left = (parseFloat(n.el.style.left) + dx) + 'px';
      n.el.style.top  = (parseFloat(n.el.style.top)  + dy) + 'px';
    });
    panX = e.clientX;
    panY = e.clientY;
    draw();
  });
  document.addEventListener('mouseup', ()=>{
    if(panning){
      const moved = panSnapshot.some(o=>{
        const n = nodes.find(nd=>nd.id===o.id);
        return n && (Math.abs(parseFloat(n.el.style.left)-o.l)>5 || Math.abs(parseFloat(n.el.style.top)-o.tp)>5);
      });
      if(moved) capture();
    }
    panning = false;
    c.classList.remove('grabbing');
  });

  // Double-click to add node
  c.addEventListener('dblclick', e=>{
    if(e.target===c || e.target===s){
      makeNode('New idea', e.clientX-70, e.clientY-30);
    }
  });

  // Save logic
  async function saveNewWithTitle(tt){
    const mp = {
      title: tt,
      nodes: nodes.map(n=>({
        id:n.id, p:n.p,
        t:n.el.querySelector('.txt').textContent,
        l:parseFloat(n.el.style.left),
        tp:parseFloat(n.el.style.top),
        w:n.el.offsetWidth, h:n.el.offsetHeight
      })),
      ts: Date.now()
    };
    const gv = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    gv.push(mp);
    currentIndex = gv.length-1;
    originalTitle = tt;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(gv));
    titleInput.value = tt;
    renderGallery();
    await modalAlert(`Map saved as: ${tt}`);
  }

  async function save(){
    const tt = titleInput.value.trim();
    if(currentIndex !== null && originalTitle !== ''){
      const mp = {
        title: tt || originalTitle,
        nodes: nodes.map(n=>({
          id:n.id, p:n.p,
          t:n.el.querySelector('.txt').textContent,
          l:parseFloat(n.el.style.left),
          tp:parseFloat(n.el.style.top),
          w:n.el.offsetWidth, h:n.el.offsetHeight
        })),
        ts: Date.now()
      };
      const gv = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      gv[currentIndex] = mp;
      originalTitle = tt || originalTitle;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(gv));
      titleInput.value = originalTitle;
      renderGallery();
      await modalAlert(`Map changes saved to: ${originalTitle}`);
    } else {
      await saveAs();
    }
  }

  async function saveAs(){
    let newTitle = await modalPrompt("Enter a title for the new map:", titleInput.value.trim() || 'Untitled map');
    if(newTitle === null){
      await modalAlert("Save As cancelled.");
      return;
    }
    newTitle = newTitle.trim();
    if(newTitle === ''){
      await modalAlert("A title is required. Save As cancelled.");
      return;
    }
    await saveNewWithTitle(newTitle);
  }

  function loadIndex(ix){
    const gv = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if(!gv[ix]) return;
    clearCanvas();
    gv[ix].nodes.forEach(n => makeNode(n.t, n.l, n.tp, n.p, n.id, n.w, n.h, true));
    titleInput.value = gv[ix].title;
    originalTitle = gv[ix].title;
    currentIndex = ix;
    capture();
  }

  function deleteIndex(ix){
    const gv = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    gv.splice(ix,1);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(gv));
    if(currentIndex === ix){
      currentIndex = null;
      originalTitle = '';
    } else if(currentIndex > ix){
      currentIndex--;
    }
    renderGallery();
  }

  function clearCanvas(){
    nodes.forEach(n => n.el.remove());
    nodes = [];
    draw();
  }

  function getEmbedLink(ix){
    const url = EMBED_BASE + '?mapId=' + ix;
    uD.textContent = url;
    uO.style.display='flex';
  }

  function renderGallery(){
    gl.innerHTML='';
    const gv = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    gv.forEach((mp,i)=>{
      const item = document.createElement('div');
      item.className='gi';

      const main = document.createElement('div');
      main.className='gi-main';
      main.onclick = ()=> loadIndex(i);

      const title = document.createElement('div');
      title.className='gt';
      title.textContent = mp.title;

      const date = document.createElement('div');
      date.className='gd';
      date.textContent = new Date(mp.ts).toLocaleString();

      main.appendChild(title);
      main.appendChild(date);

      const actions = document.createElement('div');
      actions.className='gi-actions';

      const linkBtn = document.createElement('button');
      linkBtn.className='icon-btn';
      linkBtn.title='Get embed link';
      linkBtn.textContent='ðŸ”—';
      linkBtn.onclick = (e)=>{ e.stopPropagation(); getEmbedLink(i); };

      const delBtn = document.createElement('button');
      delBtn.className='icon-btn danger';
      delBtn.title='Delete';
      delBtn.textContent='Ã—';
      delBtn.onclick = (e)=>{ e.stopPropagation(); deleteIndex(i); };

      actions.appendChild(linkBtn);
      actions.appendChild(delBtn);

      item.appendChild(main);
      item.appendChild(actions);
      gl.appendChild(item);
    });
  }

  // New map
  function newMap(){
    clearCanvas();
    makeNode('New mindmap', innerWidth/2-90, innerHeight/2-40, null, null, null, null, true);
    titleInput.value='';
    currentIndex = null;
    originalTitle = '';
    capture();
  }

  // Controls
  btnSave.onclick = save;
  btnSaveAs.onclick = saveAs;
  btnNew.onclick = newMap;
  btnEmbed.onclick = ()=>{
    const gv = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if(currentIndex === null || !gv[currentIndex]){
      modalAlert('Save the map first to generate an embed link.');
      return;
    }
    getEmbedLink(currentIndex);
  };

  btnUndo.onclick = ()=>{
    if(historyIndex>0){
      restore(historyStack[--historyIndex]);
    }
  };
  btnRedo.onclick = ()=>{
    if(historyIndex<historyStack.length-1){
      restore(historyStack[++historyIndex]);
    }
  };

  document.addEventListener('keydown', e=>{
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    const cmd = isMac ? e.metaKey : e.ctrlKey;

    if(cmd && e.key.toLowerCase()==='z' && !e.shiftKey){
      e.preventDefault();
      if(historyIndex>0) restore(historyStack[--historyIndex]);
    } else if(cmd && (e.key.toLowerCase()==='y' || (e.key.toLowerCase()==='z' && e.shiftKey))){
      e.preventDefault();
      if(historyIndex<historyStack.length-1) restore(historyStack[++historyIndex]);
    }
  });

  // URL param loading
  const params = new URLSearchParams(window.location.search);
  const mI = params.get('mapId');
  const gv = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  let loadIx = null;
  if(mI !== null && mI !== ''){
    const i = parseInt(mI);
    if(i>=0 && i<gv.length){
      loadIx = i;
    }
  }

  if(loadIx !== null){
    clearCanvas();
    gv[loadIx].nodes.forEach(n => makeNode(n.t, n.l, n.tp, n.p, n.id, n.w, n.h, true));
    titleInput.value = gv[loadIx].title;
    originalTitle = gv[loadIx].title;
    currentIndex = loadIx;
  } else {
    makeNode('New idea', innerWidth/2-90, innerHeight/2-40, null, null, null, null, true);
  }

  capture();
  renderGallery();
})();
</script>
</body>
</html>

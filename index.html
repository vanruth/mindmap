<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
  :root {
    --bg-color: #f7f7f7;
    --node-bg: #ffffff;
    --node-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 5px 15px rgba(0, 0, 0, 0.05);
    --node-hover-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 10px 30px rgba(0, 0, 0, 0.08);
    --border-color: #e0e0e0;
    --text-color: #333333;
    --subtle-text: #888888;
    --accent-color: #4A90E2; /* Notion blue */
    --danger-color: #E05252;
    --control-bg: rgba(255, 255, 255, 0.9);
    --control-button-bg: #f2f2f2;
    --control-button-hover-bg: #e5e5e5;
    --control-button-active-bg: #d4d4d4;
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-color);
    overflow: hidden;
    height: 100vh;
    color: var(--text-color);
    font-size: 15px;
  }
  #c {
    width: 100%;
    height: 100vh;
    position: relative;
    cursor: grab;
  }
  #c.grabbing {
    cursor: grabbing;
  }
  svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }
  .conn {
    stroke: var(--border-color);
    stroke-width: 2;
    fill: none;
    transition: stroke 0.2s ease-in-out;
  }
  .node {
    position: absolute;
    background: var(--node-bg);
    border-radius: 8px; /* Softer corners */
    min-width: 120px;
    max-width: 400px;
    box-shadow: var(--node-shadow);
    transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
    z-index: 10;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
  .node:hover {
    transform: scale(1.01);
    box-shadow: var(--node-hover-shadow);
    z-index: 20;
  }
  .node.drag {
    opacity: 0.85;
    z-index: 1000;
    box-shadow: var(--node-hover-shadow);
  }
  .txt {
    outline: none;
    border: none;
    background: transparent;
    font-size: 16px;
    font-weight: 500;
    color: var(--text-color);
    width: 100%;
    padding: 12px 16px;
    text-align: left;
    cursor: text;
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 40px;
    line-height: 1.4;
  }
  .txt:empty:before {
    content: attr(data-placeholder);
    color: var(--subtle-text);
    cursor: text;
  }
  .bdy {
    cursor: grab;
    flex-grow: 1;
    position: relative;
  }
  .rh {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 20px;
    height: 20px;
    cursor: nwse-resize;
    z-index: 40;
    background: radial-gradient(circle at top left, transparent 50%, var(--border-color) 50%);
    border-bottom-right-radius: 8px;
    opacity: 0.7;
    transition: opacity 0.15s ease-out;
  }
  .node:hover .rh {
    opacity: 1;
  }
  .acts {
    position: absolute;
    top: -36px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 4px;
    z-index: 50;
    opacity: 0;
    transition: opacity 0.2s ease-out, top 0.2s ease-out;
    pointer-events: none;
  }
  .node:hover .acts {
    opacity: 1;
    top: -40px;
    pointer-events: auto;
  }
  .acts button {
    width: 30px;
    height: 30px;
    border-radius: 6px;
    border: none;
    background: var(--control-button-bg);
    color: var(--subtle-text);
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, transform 0.1s ease-out;
  }
  .acts button:hover {
    background: var(--control-button-hover-bg);
    transform: translateY(-1px);
  }
  .acts button:active {
    background: var(--control-button-active-bg);
    transform: translateY(0);
  }
  .acts button svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
    stroke-width: 2.5;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  .add {
    color: var(--accent-color);
  }
  .del {
    color: var(--danger-color);
  }

  /* Control Panel */
  #ctrl {
    position: fixed;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--control-bg);
    padding: 8px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    z-index: 50;
    opacity: 0.9;
    transition: opacity 0.2s ease-in-out;
  }
  #ctrl:hover {
    opacity: 1;
  }
  #ctrl button {
    padding: 8px 10px;
    border-radius: 6px;
    border: none;
    background: var(--control-button-bg);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background-color 0.15s ease-in-out, transform 0.1s ease-out, box-shadow 0.15s ease-in-out;
  }
  #ctrl button:hover {
    background: var(--control-button-hover-bg);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }
  #ctrl button:active {
    background: var(--control-button-active-bg);
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  #ctrl button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    background: var(--control-button-bg);
  }
  #ctrl button svg {
    position: relative;
    width: 18px;
    height: 18px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
    pointer-events: none;
  }
  #ctrl input {
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    width: 160px;
    font-size: 14px;
    background: var(--node-bg);
    color: var(--text-color);
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
  }

  /* Gallery and Modals styling (omitted for brevity, assume they are included as in the full code) */
</style>

<div id="c">
  <svg id="s"></svg>
</div>

<div id="ctrl">
  <input id="t" type="text" placeholder="Untitled Mindmap"/>

  <button id="n" title="New Mindmap">
    <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
    <span>New</span>
  </button>
  <button id="sv" title="Save Map">
    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
    <span>Save</span>
  </button>
  <button id="sa" title="Save As New Copy">
    <svg viewBox="0 0 24 24"><path d="M17 19H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><path d="M10 13l2-2 4 4"></path><path d="M10 17h2v2"></path><path d="M7 3v5h8"></path></svg>
    <span>Save As</span>
  </button>
  <button id="tg" title="Open Gallery">
    <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.39L22 7.61V19z"></path><path d="M17 8H7a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2z"></path><rect x="9" y="11" width="6" height="6" rx="1"></rect></svg>
    <span>Gallery</span>
  </button>
  <button id="u" title="Undo Last Action">
    <svg viewBox="0 0 24 24"><path d="M9 14L4 9l5-5"></path><path d="M20 20v-7a4 4 0 0 0-4-4H4"></path></svg>
    <span>Undo</span>
  </button>
  <button id="r" title="Redo Last Action">
    <svg viewBox="0 0 24 24"><path d="M15 14l5-5-5-5"></path><path d="M4 20v-7a4 4 0 0 1 4-4h12"></path></svg>
    <span>Redo</span>
  </button>
</div>

<div id="gal">
  <h3>Saved Maps</h3>
  <div id="gl"></div>
</div>

<div id="u-o" class="m-o">
  <div class="m-b">
    <h4>Copy this URL to embed this specific map:</h4>
    <div id="u-d"></div>
    <button onclick="document.getElementById('u-o').classList.remove('show')" class="m-b-g b-s">Close</button>
  </div>
</div>

<div id="p-o" class="m-o">
  <div class="m-b">
    <h4 id="pm"></h4>
    <input type="text" id="p-i" placeholder="Enter title" style="display:none;">
    <div class="m-b-g">
      <button id="pc" class="b-p" style="display:none;">Confirm</button>
      <button id="pnc" class="b-s" style="display:none;">Cancel</button>
      <button id="pao" class="b-i" style="display:none;">OK</button>
    </div>
  </div>
</div>

<script>
  ((B = 'https://[YOUR_GITHUB_PAGES_URL_HERE]', // IMPORTANT: Change this placeholder URL to your actual GitHub Pages URL!
    c = document.getElementById('c'),
    s = document.getElementById('s'),
    g = document.getElementById('gal'),
    uO = document.getElementById('u-o'),
    uD = document.getElementById('u-d'),
    pO = document.getElementById('p-o'),
    pM = document.getElementById('pm'),
    pI = document.getElementById('p-i'),
    pC = document.getElementById('pc'),
    pNC = document.getElementById('pnc'),
    pAO = document.getElementById('pao'),
    k = 'mgd') => {

    let ns = [],
      dr = null,
      ox = 0,
      oy = 0,
      pn = false,
      px = 0,
      py = 0,
      h = [],
      hi = -1,
      ci = null,
      ot = '',
      rz = null,
      rs = {};

    function showModal(modalEl) {
      modalEl.style.display = 'flex';
      setTimeout(() => modalEl.classList.add('show'), 10);
    }

    function hideModal(modalEl) {
      modalEl.classList.remove('show');
      modalEl.addEventListener('transitionend', function handler() {
        modalEl.style.display = 'none';
        modalEl.removeEventListener('transitionend', handler);
      }, {
        once: true
      });
    }

    function ca(m) {
      return new Promise(r => {
        pM.textContent = m;
        pI.style.display = 'none';
        pC.style.display = 'none';
        pNC.style.display = 'none';
        pAO.style.display = 'inline-block';
        const handler = () => {
          pAO.removeEventListener('click', handler);
          hideModal(pO);
          r();
        };
        pAO.addEventListener('click', handler);
        showModal(pO);
      });
    }

    function cp(m, d = '') {
      return new Promise(r => {
        pM.textContent = m;
        pI.value = d;
        pI.style.display = 'block';
        pC.style.display = 'inline-block';
        pNC.style.display = 'inline-block';
        pAO.style.display = 'none';
        const hC = () => {
          remH();
          hideModal(pO);
          r(pI.value);
        };
        const hCN = () => {
          remH();
          hideModal(pO);
          r(null);
        };
        const remH = () => {
          pC.removeEventListener('click', hC);
          pNC.removeEventListener('click', hCN);
        };
        pC.addEventListener('click', hC);
        pNC.addEventListener('click', hCN);
        showModal(pO);
        pI.focus();
        pI.select();
      });
    }

    function cap() {
      const st = {
        nodes: ns.map(n => ({
          id: n.id,
          p: n.p,
          t: n.el.querySelector('.txt').textContent,
          l: parseFloat(n.el.style.left),
          tp: parseFloat(n.el.style.top),
          w: n.el.offsetWidth,
          h: n.el.offsetHeight
        })),
        title: document.getElementById('t').value
      };
      if (hi < h.length - 1) h = h.slice(0, hi + 1);
      h.push(JSON.parse(JSON.stringify(st)));
      if (h.length > 50) h.shift();
      else hi++;
      document.getElementById('u').disabled = hi <= 0;
      document.getElementById('r').disabled = hi >= h.length - 1;
    }

    function rst(st) {
      clr();
      st.nodes.forEach(n => mkn(n.t, n.l, n.tp, n.p, n.id, n.w, n.h, true));
      document.getElementById('t').value = st.title;
      document.getElementById('u').disabled = hi <= 0;
      document.getElementById('r').disabled = hi >= h.length - 1;
    }

    function mkn(tx, x, y, p = null, id = null, w = null, ht = null, sk = false) {
      const d = document.createElement('div');
      d.className = 'node';
      d.style.left = x + 'px';
      d.style.top = y + 'px';
      if (w) {
        d.style.width = w + 'px';
        d.dataset.resizedByUser = 'true';
      }
      if (ht) {
        d.style.height = ht + 'px';
        d.dataset.resizedByUser = 'true';
      }

      id = id || 'n' + Date.now() + Math.random().toString(36).substr(2, 5);
      d.dataset.id = id;
      d.dataset.p = p || '';

      const b = document.createElement('div');
      b.className = 'bdy';

      const acts = document.createElement('div');
      acts.className = 'acts';

      const addBtn = document.createElement('button');
      addBtn.className = 'add';
      addBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>';
      addBtn.title = 'Add child node';
      addBtn.onclick = e => {
        e.stopPropagation();
        adc(id);
      };
      acts.appendChild(addBtn);

      const delBtn = document.createElement('button');
      delBtn.className = 'del';
      delBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
      delBtn.title = 'Delete node and children';
      delBtn.onclick = e => {
        e.stopPropagation();
        dln(id);
      };
      acts.appendChild(delBtn);

      b.appendChild(acts);

      const td = document.createElement('div');
      td.className = 'txt';
      td.contentEditable = true;
      td.textContent = tx;
      td.dataset.placeholder = 'New Idea';

      let tm;
      td.addEventListener('input', () => {
        if (!d.dataset.resizedByUser) {
          const minW = 120, maxW = 400;
          let newWidth = td.scrollWidth + 32;
          d.style.width = Math.max(minW, Math.min(maxW, newWidth)) + 'px';
        }
        drw();
        clearTimeout(tm);
        tm = setTimeout(() => cap(), 500);
      });
      if (tx && !w) {
         const minW = 120, maxW = 400;
         let newWidth = td.scrollWidth + 32;
         d.style.width = Math.max(minW, Math.min(maxW, newWidth)) + 'px';
      }

      b.appendChild(td);
      d.appendChild(b);

      const hd = document.createElement('div');
      hd.className = 'rh';
      hd.addEventListener('mousedown', e => {
        e.stopPropagation();
        srz(e, d);
      });
      d.appendChild(hd);

      c.appendChild(d);
      ns.push({
        id,
        el: d,
        p
      });
      b.addEventListener('mousedown', e => {
        if (e.target === b || e.target === td || e.target === td.parentElement) sdg(e, d);
      });

      drw();
      if (!sk) cap();
      return id;
    }

    function srz(e, el) {
      rz = el;
      rz.dataset.resizedByUser = 'true';
      rs = {
        x: e.clientX,
        y: e.clientY,
        w: el.offsetWidth,
        h: el.offsetHeight
      };
      e.preventDefault();
      document.addEventListener('mousemove', drz);
      document.addEventListener('mouseup', stz);
    }

    function drz(e) {
      if (!rz) return;
      const dx = e.clientX - rs.x,
        dy = e.clientY - rs.y;
      rz.style.width = Math.max(120, rs.w + dx) + 'px';
      rz.style.height = Math.max(40, rs.h + dy) + 'px';
      drw();
    }

    function stz() {
      if (rz) cap();
      rz = null;
      document.removeEventListener('mousemove', drz);
      document.removeEventListener('mouseup', stz);
    }

    function adc(pid) {
      const p = ns.find(n => n.id === pid);
      if (!p) return;
      const rc = p.el.getBoundingClientRect();
      const ct = ns.filter(n => n.p === pid).length,
        an = (Math.PI * 2 * ct / 5) + (Math.random() * .4 - .2),
        d = 180;
      const x = rc.left + rc.width / 2 + Math.cos(an) * d - 60,
        y = rc.top + rc.height / 2 + Math.sin(an) * d - 30;
      mkn('New Idea', x, y, pid);
    }

    function dln(id) {
      const i = ns.findIndex(n => n.id === id);
      if (i == -1) return;
      ns.filter(n => n.p === id).forEach(kd => dln(kd.id));
      ns[i].el.remove();
      ns.splice(i, 1);
      drw();
      cap();
    }

    function sdg(e, el) {
      // Prevent drag if clicking on the text input (editing)
      if (e.target.closest('.txt') === el.querySelector('.txt')) return;

      dr = el;
      dr.classList.add('drag');
      const rc = dr.getBoundingClientRect();
      ox = e.clientX - rc.left;
      oy = e.clientY - rc.top;
      e.preventDefault();
      document.addEventListener('mousemove', dg);
      document.addEventListener('mouseup', stg);
    }

    function dg(e) {
      if (!dr) return;
      dr.style.left = (e.clientX - ox) + 'px';
      dr.style.top = (e.clientY - oy) + 'px';
      drw();
    }

    function stg() {
      if (dr) {
        dr.classList.remove('drag');
        cap();
      }
      dr = null;
      document.removeEventListener('mousemove', dg);
      document.removeEventListener('mouseup', stg);
    }

    function drw() {
      s.innerHTML = '';
      ns.forEach(n => {
        if (!n.p) return;
        const p = ns.find(x => x.id === n.p);
        if (!p) return;
        const pr = p.el.getBoundingClientRect(),
          nr = n.el.getBoundingClientRect();
        const x1 = pr.left + pr.width / 2,
          y1 = pr.top + pr.height / 2,
          x2 = nr.left + nr.width / 2,
          y2 = nr.top + nr.height / 2,
          mx = (x1 + x2) / 2,
          my = (y1 + y2) / 2;
        const pt = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        pt.setAttribute('d', `M${x1},${y1} Q${mx},${y1} ${mx},${my} T${x2},${y2}`);
        pt.setAttribute('class', 'conn');
        s.appendChild(pt);
      });
    }

    let ps;
    c.addEventListener('mousedown', e => {
      if (e.target === c || e.target === s) {
        pn = true;
        px = e.clientX;
        py = e.clientY;
        c.classList.add('grabbing');
        ps = ns.map(n => ({
          id: n.id,
          l: parseFloat(n.el.style.left),
          tp: parseFloat(n.el.style.top)
        }))
      }
    });
    document.addEventListener('mousemove', e => {
      if (!pn) return;
      const dx = e.clientX - px,
        dy = e.clientY - py;
      ns.forEach(n => {
        n.el.style.left = (parseFloat(n.el.style.left) + dx) + 'px';
        n.el.style.top = (parseFloat(n.el.style.top) + dy) + 'px';
      });
      px = e.clientX;
      py = e.clientY;
      drw();
    });
    document.addEventListener('mouseup', () => {
      if (pn) {
        const mv = ps.some((o, i) => {
          const n = ns.find(nd => nd.id === o.id);
          return n && (Math.abs(parseFloat(n.el.style.left) - o.l) > 5 || Math.abs(parseFloat(n.el.style.top) - o.tp) > 5)
        });
        if (mv) cap()
      }
      pn = false;
      c.classList.remove('grabbing')
    });
    c.addEventListener('dblclick', e => {
      if (e.target === c || e.target === s) mkn('New Idea', e.clientX - 60, e.clientY - 30)
    });

    async function sva(tt) {
      const mp = {
        title: tt,
        nodes: ns.map(n => ({
          id: n.id,
          p: n.p,
          t: n.el.querySelector('.txt').textContent,
          l: parseFloat(n.el.style.left),
          tp: parseFloat(n.el.style.top),
          w: n.el.offsetWidth,
          h: n.el.offsetHeight
        })),
        ts: Date.now()
      };
      const gv = JSON.parse(localStorage.getItem(k) || '[]');
      gv.push(mp);
      ci = gv.length - 1;
      ot = tt;
      localStorage.setItem(k, JSON.stringify(gv));
      document.getElementById('t').value = tt;
      rgl();
      await ca(`Map saved as: ${tt}`);
    }

    async function sv() {
      const tt = document.getElementById('t').value.trim();
      if (ci !== null && ot !== '') {
        const mp = {
          title: tt || ot,
          nodes: ns.map(n => ({
            id: n.id,
            p: n.p,
            t: n.el.querySelector('.txt').textContent,
            l: parseFloat(n.el.style.left),
            tp: parseFloat(n.el.style.top),
            w: n.el.offsetWidth,
            h: n.el.offsetHeight
          })),
          ts: Date.now()
        };
        const gv = JSON.parse(localStorage.getItem(k) || '[]');
        gv[ci] = mp;
        ot = tt || ot;
        localStorage.setItem(k, JSON.stringify(gv));
        document.getElementById('t').value = ot;
        rgl();
        await ca(`Map changes saved to: ${ot}`);
      } else {
        await sa();
      }
    }

    async function sa() {
      let nT = await cp("Enter a title for the new map:", document.getElementById('t').value.trim() || 'Untitled Map');
      if (nT === null) {
        await ca("Save As cancelled.");
        return
      }
      nT = nT.trim();
      if (nT === '') {
        await ca("A title is required. Save As cancelled.");
        return
      }
      // Check for duplicate title before saving
      const gv = JSON.parse(localStorage.getItem(k) || '[]');
      if (gv.some(map => map.title === nT)) {
          await ca(`Map with title "${nT}" already exists. Please choose a different title.`);
          return;
      }
      await sva(nT);
    }

    function ld(ix) {
      const gv = JSON.parse(localStorage.getItem(k) || '[]');
      if (!gv[ix]) return;
      clr();
      gv[ix].nodes.forEach(n => mkn(n.t, n.l, n.tp, n.p, n.id, n.w, n.h, true));
      document.getElementById('t').value = gv[ix].title;
      ot = gv[ix].title;
      ci = ix;
      cap();
      hideModal(g); // Close gallery after loading
    }

    function dlg(ix) {
      const gv = JSON.parse(localStorage.getItem(k) || '[]');
      gv.splice(ix, 1);
      localStorage.setItem(k, JSON.stringify(gv));
      if (ci === ix) {
        ci = null
      } else if (ci > ix) {
        ci--
      }
      rgl();
    }

    function clr() {
      ns.forEach(n => n.el.remove());
      ns = [];
      drw();
    }

    function getLink(ix) {
      // B is the base URL of your hosted application (e.g., your GitHub Pages URL)
      const eU = B + '?mapId=' + ix;
      uD.textContent = eU;
      uD.onclick = () => {
          navigator.clipboard.writeText(eU);
          alert('Copied to clipboard!');
      }
      showModal(uO);
    }

    function rgl() {
      const ls = document.getElementById('gl');
      ls.innerHTML = '';
      const gv = JSON.parse(localStorage.getItem(k) || '[]');
      if (gv.length === 0) {
        ls.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--subtle-text);">No saved maps yet.</div>`;
        return;
      }
      gv.forEach((mp, i) => {
        const dv = document.createElement('div');
        dv.className = 'gi';

        const lb = document.createElement('button');
        lb.className = 'glk';
        lb.innerHTML = '<svg viewBox="0 0 24 24"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg>';
        lb.title = 'Copy Embed Link';
        lb.onclick = (e) => {
          e.stopPropagation();
          getLink(i);
        };
        dv.appendChild(lb);

        const sp = document.createElement('div');
        sp.style.flexGrow = 1;
        sp.onclick = () => ld(i);
        const td = document.createElement('div');
        td.className = 'gt';
        td.textContent = mp.title;
        const dd = document.createElement('div');
        dd.className = 'gd';
        dd.textContent = new Date(mp.ts).toLocaleString();
        sp.appendChild(td);
        sp.appendChild(dd);

        const bt = document.createElement('button');
        bt.className = 'dgb';
        bt.innerHTML = '<svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>';
        bt.title = 'Delete Map';
        bt.onclick = (e) => {
          e.stopPropagation();
          dlg(i);
        };
        dv.appendChild(sp);
        dv.appendChild(bt);
        ls.appendChild(dv)
      })
    }

    function nw() {
      clr();
      mkn('New Idea', innerWidth / 2 - 60, innerHeight / 2 - 30);
      document.getElementById('t').value = '';
      ci = null;
      ot = '';
      cap();
      rgl();
      if(g.classList.contains('show')) hideModal(g);
    }

    document.getElementById('sv').onclick = sv;
    document.getElementById('sa').onclick = sa;
    document.getElementById('n').onclick = nw;
    document.getElementById('u').onclick = () => {
      if (hi > 0) {
        rst(h[--hi])
      }
    };
    document.getElementById('r').onclick = () => {
      if (hi < h.length - 1) {
        rst(h[++hi])
      }
    };
    document.getElementById('tg').onclick = () => {
      if (g.style.display === 'none' || !g.classList.contains('show')) {
        rgl();
        showModal(g);
      } else {
        hideModal(g);
      }
    };

    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        if (hi > 0) {
          rst(h[--hi])
        }
      } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        if (hi < h.length - 1) {
          rst(h[++hi])
        }
      }
    });

    // Check for embed link parameter on load
    const uP = new URLSearchParams(window.location.search);
    const mI = uP.get('mapId');
    const gv = JSON.parse(localStorage.getItem(k) || '[]');
    let iI = null;
    if (mI !== null && mI !== '') {
      const i = parseInt(mI);
      if (i >= 0 && i < gv.length) {
        iI = i
      }
    }
    
    // Load existing map or create new one
    if (iI !== null) {
      const tli = iI;
      clr();
      gv[tli].nodes.forEach(n => mkn(n.t, n.l, n.tp, n.p, n.id, n.w, n.h, true));
      document.getElementById('t').value = gv[tli].title;
      ot = gv[tli].title;
      ci = tli;
    } else {
      // Default initial state
      mkn('New Idea', innerWidth / 2 - 60, innerHeight / 2 - 30, null, null, null, null, true)
    }

    cap();
    rgl();
  })();
</script>
